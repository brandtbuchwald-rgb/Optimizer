<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rediscover ATKSPD Build Optimizer</title>
<style>
  :root{
    --bg:#1b130d;--ink:#e8d9bb;--muted:#b7a88c;--box:#2a2119;--line:#504230;--frame:#d6c7a6;
    --good:#7bd389;--warn:#ffcf5a;--bad:#ff7a7a;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif}
  h1{font-size:18px;margin:16px 12px}
  .wrap{max-width:1200px;margin:0 auto;padding:8px}
  .panel{background:var(--box);border:1px solid var(--line);border-radius:12px;padding:12px;margin:8px}
  label{font-size:12px;color:var(--muted);margin:4px 8px 4px 0;display:inline-block}
  input,select{padding:6px;border-radius:6px;border:1px solid var(--frame);background:#21170f;color:var(--ink)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--frame);background:#23190f;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;margin:4px 6px}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid #3a2f24;padding:6px;font-size:12px;text-align:right;vertical-align:top}
  th:first-child,td:first-child{text-align:left}
  .pill{display:inline-block;border:1px solid var(--frame);border-radius:999px;padding:2px 8px;margin-left:6px}
  .ok{color:var(--good)} .meh{color:var(--warn)} .no{color:var(--bad)}
  canvas{max-width:100%;display:block;margin:10px auto;border-radius:12px;border:1px solid #402f22}
  .muted{color:var(--muted)}
  .subtitle{color:#d1c4a5;font-weight:600;margin:8px 0 4px}
  .tag{display:inline-block;border:1px solid #6b5b45;border-radius:8px;padding:2px 6px;margin:2px 4px 0 0;color:#d6c7a6}
</style>
</head>
<body>
<h1>Rediscover ATKSPD Build Optimizer</h1>
<div class="wrap">

  <!-- Class toggles -->
  <div class="panel">
    <strong>Class</strong><br>
    <label><input type="radio" name="cls" value="Paladin"> Paladin</label>
    <label><input type="radio" name="cls" value="Sorcerer" checked> Sorcerer</label>
    <label><input type="radio" name="cls" value="Ranger"> Ranger</label>
    <label><input type="radio" name="cls" value="Berserker"> Berserker</label>
  </div>

  <!-- Monster toggles -->
  <div class="panel">
    <strong>Monster Types</strong><br>
    <label><input type="checkbox" value="Tank"> Tank</label>
    <label><input type="checkbox" value="Demon"> Demon</label>
    <label><input type="checkbox" value="Animal"> Animal</label>
    <label><input type="checkbox" value="Primate"> Primate</label>
    <label><input type="checkbox" value="Undead"> Undead</label>
    <label><input type="checkbox" value="Boss"> Boss</label>
  </div>

  <!-- Runes -->
  <div class="panel">
    <strong>Runes</strong><br>
    <label><input type="checkbox" id="evaRune"> +6% Evasion Rune</label>
    <label><input type="checkbox" id="drRune"> +12% Damage Reduce Rune</label>
  </div>

  <!-- Weapon -->
  <div class="panel">
    <label>Weapon Category</label>
    <select id="weaponCat">
      <option value="normal">Normal</option>
      <option value="glacial">Glacial</option>
      <option value="blaze">Blaze</option>
      <option value="darkness">Darkness</option>
      <option value="venom">Venom</option>
    </select>
    <label>Weapon Type</label>
    <select id="weaponType"></select>
  </div>

  <!-- Targets & Weights -->
  <div class="panel">
    <div class="row">
      <div>
        <div class="subtitle">Targets (caps enforced)</div>
        <div class="muted">ATK SPD target auto: 0.45 if Tank+Primal, else 0.25</div>
        <label>Target Crit % (cap 50%)</label>
        <input id="t_crit" type="number" step="1" value="50" style="width:90px">
      </div>
      <div>
        <div class="subtitle">Bonus Weights</div>
        Crit DMG <input id="w_cd" type="number" value="1" style="width:60px">
        ATK% <input id="w_atk" type="number" value="1" style="width:60px">
        Demon DMG <input id="w_dd" type="number" value="1" style="width:60px">
      </div>
    </div>
    <div id="status" class="pill">ready</div>
  </div>

  <!-- Auto-generated slot table -->
  <div class="panel">
    <strong>Per-slot stats (auto-generated by gear type)</strong>
    <div class="muted">Weapons can’t roll ATK SPD / Evasion / Crit. Chaos/Abyss show their 5th-pool options below the base stats.</div>
    <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
      <div class="muted">Gear: <span id="gearLabel">Primal</span> • Limit: <span id="limitLabel">3</span> stats per piece<span id="extraLabel" class="muted"></span></div>
      <button class="btn" id="regen">Regenerate for current gear</button>
    </div>
    <div style="overflow:auto;max-height:360px">
      <table id="slotTable">
        <thead>
          <tr>
            <th>Slot</th>
            <th>Base stat lines (per line value)</th>
            <th>5th-pool options (Chaos/Abyss)</th>
          </tr>
        </thead>
        <tbody id="slotRows"></tbody>
      </table>
    </div>
  </div>

  <!-- Actions -->
  <div class="panel">
    <button class="btn" id="run">Optimize</button>
    <button class="btn" id="render">Render Picture</button>
    <button class="btn" id="save">Download PNG</button>
  </div>

  <!-- Results -->
  <div class="panel">
    <strong>Chosen stats per slot</strong>
    <div id="result">—</div>
  </div>

  <!-- Card -->
  <div class="panel">
    <strong>Printable Card</strong>
    <canvas id="card" width="1200" height="800"></canvas>
  </div>

</div>

<script>
/* ===========================
   Data
=========================== */
const BASE_SLOTS = ["Weapon","Necklace","Helm","Chest","Ring","Belt","Gloves","Boots"];
const SHOW_STATS_ORDER = ["atkspd","eva","crit","critdmg","atkpct","demondmg","hp","def","dr"];

const LABELS = {
  atkspd:"ATK SPD", eva:"Evasion", crit:"Crit", critdmg:"Crit DMG",
  atkpct:"ATK%", demondmg:"Demon DMG", hp:"HP", def:"DEF", dr:"Damage Reduce",
  mats:"Chance High-Class Mats", bossdmg:"Boss Damage"
};

// Real per-line values (from your sheet)
const POOLS = {
  Primal:   { atkspd:0.12, eva:12, crit:12, atkpct:23, critdmg:35, hp:23, def:23, dr:14, demondmg:0 },
  Original: { atkspd:0.12, eva:12, crit:12, atkpct:23, critdmg:35, hp:23, def:23, dr:17, demondmg:0 },
  Chaos:    { atkspd:0.14, eva:14, crit:14, atkpct:26, critdmg:40, hp:26, def:26, dr:19, demondmg:0 },
  Abyss:    { atkspd:0.16, eva:16, crit:16, atkpct:29, critdmg:45, hp:29, def:29, dr:21, demondmg:0 }
};

// Extra pool — store as actual effects (objects), not strings
const EXTRA_POOL = {
  Chaos: {
    Chest:    [{atkpct:26},{dr:19},{mats:26}],
    Gloves:   [{atkpct:26},{dr:19},{mats:26}],
    Boots:    [{atkpct:26},{dr:19},{mats:26}],
    Belt:     [{hp:26},{bossdmg:40},{mats:26}],
    Helm:     [{hp:26},{bossdmg:40},{mats:26}],
    Necklace: [{critdmg:40},{mats:26}], // evasion excluded
    Ring:     [{critdmg:40},{mats:26}],
    Weapon:   [{critdmg:80},{hp:52},{mats:26}]
  },
  Abyss: {
    Chest:    [{atkpct:29},{dr:21},{mats:29}],
    Gloves:   [{atkpct:29},{dr:21},{mats:29}],
    Boots:    [{atkpct:29},{dr:21},{mats:29}],
    Belt:     [{hp:29},{bossdmg:45},{mats:29}],
    Helm:     [{hp:29},{bossdmg:45},{mats:29}],
    Necklace: [{critdmg:45},{mats:29}], // evasion excluded
    Ring:     [{critdmg:45},{mats:29}],
    Weapon:   [{mats:29}] // TBDs unknown; keep mats only for now
  }
};

// Boss weapons (summary)
const BOSS_WEAPONS = {
  glacial:{
    Sword:{name:"Glacial Sword",stats:["ATK% +14–26","Damage vs Monsters +25–40","Crit DMG +25–40"],skill:"Chance to cast Rampage"},
    Bow:{name:"Glacial Bow",stats:["ATK% +14–26","Damage vs Monsters +25–40","Crit DMG +25–40"],skill:"Chance to cast Frozen Soul"},
    Staff:{name:"Glacial Staff",stats:["ATK% +14–26","Damage vs Monsters +25–40","Crit DMG +25–40"],skill:"Chance to cast Frozen Soul"}
  },
  blaze:{
    Hammer:{name:"Blaze Hammer",stats:["ATK% +14–26","Damage vs Monsters +25–40","Crit DMG +25–40"],skill:"Chance to cast Dragon’s Rage"},
    Staff:{name:"Blaze Staff",stats:["ATK% +14–26","Damage vs Monsters +25–40","Crit DMG +25–40"],skill:"Chance to cast Primordial Power"}
  },
  darkness:{
    Sword:{name:"Darkness Sword",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Dark Fissure"},
    Hammer:{name:"Darkness Hammer",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Dark Lightning"},
    Bow:{name:"Darkness Bow",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Feather Shot"},
    Staff:{name:"Darkness Staff",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Soul Eater"}
  },
  venom:{
    Blade:{name:"Venom Blade",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to x3 Damage"},
    Scythe:{name:"Venom Scythe",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Poison Aura"},
    Bow:{name:"Venom Bow",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Venom Rain"},
    Staff:{name:"Venom Staff",stats:["ATK% +11–23","Damage vs Monsters +20–35"],skill:"Chance to cast Devour"}
  }
};

/* ===========================
   UI wiring
=========================== */
const catSel = document.getElementById('weaponCat');
const typeSel = document.getElementById('weaponType');
const slotRows = document.getElementById('slotRows');
const gearLabel = document.getElementById('gearLabel');
const limitLabel = document.getElementById('limitLabel');
const extraLabel = document.getElementById('extraLabel');

function updateTypes(){
  typeSel.innerHTML = '';
  if (catSel.value === 'normal'){
    ['Primal','Original','Chaos','Abyss'].forEach(k=>{
      const o=document.createElement('option');o.value=k;o.textContent=k;typeSel.appendChild(o);
    });
  } else {
    Object.keys(BOSS_WEAPONS[catSel.value]).forEach(k=>{
      const o=document.createElement('option');o.value=k;o.textContent=k;typeSel.appendChild(o);
    });
  }
  buildSlotTable();
}
catSel.onchange = updateTypes;

/* ===========================
   Table generation
=========================== */
function weaponRestricted(stat){ return (stat==='atkspd'||stat==='eva'||stat==='crit'); }

function buildSlotTable(){
  slotRows.innerHTML='';
  const isBoss = (catSel.value!=='normal');
  const gearType = isBoss ? 'Primal' : typeSel.value || 'Primal';
  gearLabel.textContent = gearType;
  limitLabel.textContent = (gearType==='Primal') ? '3' : (gearType==='Original' ? '4' : '5 (4+extra)');
  extraLabel.textContent = (gearType==='Chaos'||gearType==='Abyss') ? ' • Extra 5th-pool active' : '';

  for (const slot of BASE_SLOTS){
    const tr=document.createElement('tr');
    const tdSlot=document.createElement('td'); tdSlot.textContent=slot; tr.appendChild(tdSlot);

    // Base stats list
    const baseTd=document.createElement('td'); baseTd.style.textAlign='left';
    const ul1=document.createElement('div');
    const baseKeys = Object.keys(POOLS[gearType]||{});
    baseKeys.forEach(st=>{
      if (slot==='Weapon' && weaponRestricted(st)) return;
      const v = POOLS[gearType][st];
      const show = (st==='atkspd') ? `${LABELS[st]}: ${v.toFixed(2)}` : `${LABELS[st]}: +${v}%`;
      const span=document.createElement('span'); span.className='tag'; span.textContent=show;
      ul1.appendChild(span);
    });
    baseTd.appendChild(ul1);
    tr.appendChild(baseTd);

    // Extra pool list
    const extraTd=document.createElement('td'); extraTd.style.textAlign='left';
    const ul2=document.createElement('div');
    if (gearType==='Chaos' || gearType==='Abyss'){
      const extras = (EXTRA_POOL[gearType]||{})[slot]||[];
      if (extras.length){
        extras.forEach(obj=>{
          const key = Object.keys(obj)[0];
          const val = obj[key];
          const show = (key==='atkspd') ? `${LABELS[key]}: ${val.toFixed(2)}`
                        : (key==='mats') ? `${LABELS[key]}: +${val}%`
                        : `${LABELS[key]||key}: +${val}%`;
          const span=document.createElement('span'); span.className='tag'; span.textContent=show;
          ul2.appendChild(span);
        });
      } else {
        const span=document.createElement('span'); span.className='muted'; span.textContent='—';
        ul2.appendChild(span);
      }
    } else {
      const span=document.createElement('span'); span.className='muted'; span.textContent='—';
      ul2.appendChild(span);
    }
    extraTd.appendChild(ul2);
    tr.appendChild(extraTd);

    slotRows.appendChild(tr);
  }
}
typeSel.onchange = buildSlotTable;
document.getElementById('regen').onclick = buildSlotTable;
updateTypes();

/* ===========================
   Optimizer
=========================== */
function combosOf(gearType, slot){
  // base choices (keys from POOLS) respecting weapon restriction
  const baseKeys = Object.keys(POOLS[gearType]||{});
  let keys = baseKeys.filter(k => !(slot==='Weapon' && weaponRestricted(k)));

  // generate up to limit base stats
  const baseLimit = (gearType==='Primal') ? 3 : 4;
  let out=[[]];
  for(const k of keys){
    const cur=out.length;
    for(let i=0;i<cur;i++){
      if(out[i].length<baseLimit) out.push(out[i].concat({[k]:POOLS[gearType][k]}));
    }
  }

  // extra pool (Chaos/Abyss): add exactly one extra option
  if (gearType==='Chaos' || gearType==='Abyss'){
    const extras=(EXTRA_POOL[gearType]||{})[slot]||[];
    const withExtra=[];
    if (extras.length){
      out.forEach(c=>{
        extras.forEach(extraObj=>{
          withExtra.push([...c, extraObj]);
        });
      });
      out = out.concat(withExtra);
    }
  }
  // filter by max length (Chaos/Abyss allow 5 total)
  const maxLen = (gearType==='Chaos' || gearType==='Abyss') ? 5 : baseLimit;
  return out.filter(c=>c.length>0 && c.length<=maxLen);
}

function optimize(){
  const gearType = (catSel.value==='normal') ? (typeSel.value||'Primal') : 'Primal';
  const bossMode = (catSel.value!=='normal');

  // Attack speed target rule
  const monsters=[...document.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>cb.value);
  const tankMode = monsters.includes('Tank');
  let atkspdTarget = 0.25;
  if (gearType==='Primal' && tankMode) atkspdTarget = 0.45;

  // Caps (runes applied to targets)
  const evaRune = document.getElementById('evaRune').checked;
  const drRune  = document.getElementById('drRune').checked;
  const evaTarget = Math.max(0, 40 - (evaRune?6:0));
  const drTarget = tankMode ? Math.max(0, 100 - (drRune?12:0)) : 0;
  const critTarget = Math.min(50, parseFloat(document.getElementById('t_crit').value)||50);

  // Weights
  const weights = {
    cd: parseFloat(document.getElementById('w_cd').value)||1,
    atk: parseFloat(document.getElementById('w_atk').value)||1,
    dd: parseFloat(document.getElementById('w_dd').value)||1
  };

  // If boss weapon: show summary and exit (no optimization)
  if (bossMode){
    const fam = catSel.value, wt = typeSel.value;
    const w = (BOSS_WEAPONS[fam]||{})[wt];
    document.getElementById('result').innerHTML = w
      ? `<div><strong>${w.name}</strong></div><div>${w.stats.join(', ')}</div><div>${w.skill}</div><div class="muted">7-slot optimization (weapon fixed)</div>`
      : 'Boss weapon selected';
    // Status bar (no rem since we didn’t optimize)
    document.getElementById('status').innerHTML = 'Boss weapon selected — run with normal gear to optimize.';
    window.__plan = null;
    return;
  }

  // Remaining targets
  let rem = { atkspd: atkspdTarget, eva: evaTarget, crit: critTarget, dr: drTarget };
  let totals = { atkspd:0, eva:0, crit:0, critdmg:0, atkpct:0, demondmg:0, hp:0, def:0, dr:0, mats:0, bossdmg:0 };
  let pick = {};

  // Scoring: hard penalties for missing targets; then bonuses favor HP/DEF, then ATK%/Crit/CritDmg/Demon
  function scoreState(remain, sum){
    const hard = 1800*remain.atkspd + 25*remain.eva + 25*remain.crit + 60*remain.dr;
    const soft = - ( 0.7*sum.hp + 0.7*sum.def
                   + weights.atk*sum.atkpct + weights.cd*sum.critdmg + weights.dd*sum.demondmg
                   + 0.2*sum.bossdmg ); // boss dmg light bonus
    return hard + soft;
  }

  for (const slot of BASE_SLOTS){
    const cands = combosOf(gearType, slot);
    let best = null, bestScore = Infinity;

    for (const choice of cands){
      // Sum contributions from this slot
      const add = { atkspd:0,eva:0,crit:0,critdmg:0,atkpct:0,demondmg:0,hp:0,def:0,dr:0,mats:0,bossdmg:0 };
      for (const ent of choice){
        const key = Object.keys(ent)[0];
        const val = ent[key];
        if (key==='atkspd'){ add.atkspd += val; }
        else if (key in add){ add[key] += val; }
        // unknown keys ignored
      }

      // Clamp helpful parts for hard targets
      const helpful = {
        atkspd: Math.max(0, Math.min(add.atkspd, rem.atkspd)),
        eva   : Math.max(0, Math.min(add.eva, rem.eva)),
        crit  : Math.max(0, Math.min(add.crit, rem.crit)),
        dr    : Math.max(0, Math.min(add.dr, rem.dr)),
        // bonuses pass-through
        critdmg:add.critdmg, atkpct:add.atkpct, demondmg:add.demondmg, hp:add.hp, def:add.def, mats:add.mats, bossdmg:add.bossdmg
      };

      const newRem = {
        atkspd: Math.max(0, rem.atkspd - helpful.atkspd),
        eva   : Math.max(0, rem.eva    - helpful.eva),
        crit  : Math.max(0, rem.crit   - helpful.crit),
        dr    : Math.max(0, rem.dr     - helpful.dr)
      };
      const newTotals = { ...totals };
      Object.keys(newTotals).forEach(k=> newTotals[k]+=helpful[k]||0);

      const sc = scoreState(newRem, newTotals);
      if (sc < bestScore){
        bestScore = sc;
        best = { choice, newRem, newTotals };
      }
    }

    pick[slot] = best.choice;
    rem = best.newRem;
    totals = best.newTotals;
  }

  // Status bar
  const s = [];
  s.push(`ATK SPD <span class="${rem.atkspd<=1e-6?'ok':(rem.atkspd<0.05?'meh':'no')}">${rem.atkspd<=1e-6?'OK':`need ${rem.atkspd.toFixed(2)}`}</span>`);
  s.push(`Evasion <span class="${rem.eva<=1e-6?'ok':(rem.eva<5?'meh':'no')}">${rem.eva<=1e-6?'OK':`need ${rem.eva.toFixed(1)}%`}</span>`);
  s.push(`Crit <span class="${rem.crit<=1e-6?'ok':(rem.crit<5?'meh':'no')}">${rem.crit<=1e-6?'OK':`need ${rem.crit.toFixed(1)}%`}</span>`);
  s.push(`DR <span class="${rem.dr<=1e-6?'ok':(rem.dr<12?'meh':'no')}">${rem.dr<=1e-6?'OK':`need ${rem.dr.toFixed(1)}%`}</span>`);
  document.getElementById('status').innerHTML = s.join(' • ');

  // Human-readable pick list
  const pretty = [];
  for (const slot of BASE_SLOTS){
    const arr = pick[slot]||[];
    const bits = arr.map(ent=>{
      const k = Object.keys(ent)[0]; const v = ent[k];
      if (k==='atkspd') return `${LABELS[k]} +${v.toFixed(2)}`;
      if (k==='mats')   return `${LABELS[k]} +${v}%`;
      return `${LABELS[k]||k} +${v}%`;
    });
    pretty.push(`<div><strong>${slot}</strong>: ${bits.length?bits.join(', '):'—'}</div>`);
  }
  document.getElementById('result').innerHTML = pretty.join('');

  // Save plan for card
  window.__plan = { pick, totals, rem, gearType, atkspdTarget, evaTarget, drTarget, critTarget };
}

/* ===========================
   Card rendering
=========================== */
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();ctx.strokeStyle='#d6c7a6';ctx.lineWidth=4;ctx.stroke();}

function renderCard(){
  const P = window.__plan;
  const C = document.getElementById('card'), ctx=C.getContext('2d');
  ctx.fillStyle='#1b130d'; ctx.fillRect(0,0,C.width,C.height);
  roundRect(ctx,20,20,C.width-40,C.height-40,18);

  // Header
  ctx.fillStyle='#e8d9bb'; ctx.font='28px ui-sans-serif, -apple-system';
  ctx.fillText('Rediscover — Optimized Build', 40, 70);
  ctx.font='16px ui-sans-serif'; ctx.fillStyle='#b7a88c';
  const cls = document.querySelector('input[name="cls"]:checked').value;
  const monsters=[...document.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>cb.value).join(', ') || 'None';
  ctx.fillText(`Class: ${cls} • Types: ${monsters}`, 40, 98);

  // Targets line
  const evaRune = document.getElementById('evaRune').checked;
  const drRune = document.getElementById('drRune').checked;
  ctx.fillText(`Targets: ATK SPD ${P.atkspdTarget.toFixed(2)} • Evasion ${P.evaTarget}${evaRune?'+6 rune':''}% • Crit ${P.critTarget}% • DR ${P.drTarget}${drRune?'+12 rune':''}%`, 40, 122);

  // Columns
  const x1=40, x2=540, x3=860; let y=150;
  ctx.fillStyle='#c9bda1'; ctx.font='18px ui-sans-serif';
  ctx.fillText('Gear & Lines', x1, y);
  ctx.fillText('Totals', x2, y);
  ctx.fillText('Checks', x3, y);
  y += 10;

  // Gear listing
  ctx.font='16px ui-sans-serif'; let gy = y+24;
  for (const slot of BASE_SLOTS){
    const arr=(P.pick||{})[slot]||[];
    ctx.fillStyle='#e8d9bb'; ctx.fillText(slot, x1, gy);
    const txt = arr.length? arr.map(ent=>{
      const k=Object.keys(ent)[0]; const v=ent[k];
      if (k==='atkspd') return `${LABELS[k]} +${v.toFixed(2)}`;
      if (k==='mats')   return `${LABELS[k]} +${v}%`;
      return `${LABELS[k]||k} +${v}%`;
    }).join('  •  ') : '—';
    ctx.fillStyle='#b7a88c'; ctx.fillText(txt, x1+130, gy);
    gy += 26;
  }

  // Totals panel
  const T=P.totals||{atkspd:0,eva:0,crit:0,dr:0,hp:0,def:0,atkpct:0,critdmg:0,demondmg:0,bossdmg:0};
  ctx.fillStyle='#e8d9bb'; ctx.font='16px ui-sans-serif';
  const tlines = [
    `ATK SPD: ${T.atkspd.toFixed(2)}`,
    `Evasion: ${T.eva.toFixed(1)}%`,
    `Crit: ${T.crit.toFixed(1)}%`,
    `Damage Reduce: ${T.dr.toFixed(1)}%`,
    `HP: ${T.hp.toFixed(0)}%`,
    `DEF: ${T.def.toFixed(0)}%`,
    `Crit DMG: ${T.critdmg.toFixed(0)}%`,
    `ATK%: ${T.atkpct.toFixed(0)}%`,
    `Demon DMG: ${T.demondmg.toFixed(0)}%`,
    `Boss DMG: ${T.bossdmg.toFixed(0)}%`
  ];
  let ty = y+28;
  tlines.forEach(line=>{ ctx.fillText(line, x2, ty); ty+=24; });

  // Checks panel
  const R=P.rem||{atkspd:0,eva:0,crit:0,dr:0};
  const ck = [
    ['ATK SPD', R.atkspd<=1e-6, R.atkspd<=1e-6?'OK':`need ${R.atkspd.toFixed(2)}`],
    ['Evasion', R.eva<=1e-6, R.eva<=1e-6?'OK':`need ${R.eva.toFixed(1)}%`],
    ['Crit', R.crit<=1e-6, R.crit<=1e-6?'OK':`need ${R.crit.toFixed(1)}%`],
    ['DR', R.dr<=1e-6, R.dr<=1e-6?'OK':`need ${R.dr.toFixed(1)}%`],
  ];
  let cy = y+28;
  ck.forEach(([name,ok,text])=>{
    ctx.fillStyle = ok?'#7bd389':'#ffcf5a';
    if (!ok && (name==='ATK SPD' ? R.atkspd>=0.05 : name==='Evasion' ? R.eva>=5 : name==='Crit' ? R.crit>=5 : name==='DR' ? R.dr>=12 : false))
      ctx.fillStyle = '#ff7a7a';
    ctx.fillText(`${name}: ${text}`, x3, cy); cy+=24;
  });

  // Footer
  ctx.fillStyle='#b7a88c';
  ctx.fillText('Guild — Rediscover Alliance • Creator — SAGE', 40, C.height-40);
}

document.getElementById('run').onclick = optimize;
document.getElementById('render').onclick = ()=>{ if(!window.__plan){ optimize(); } renderCard(); };
document.getElementById('save').onclick = ()=>{
  const a=document.createElement('a');
  a.download='rediscover_build.png';
  a.href=document.getElementById('card').toDataURL('image/png');
  a.click();
};
</script>
</body>
</html>
